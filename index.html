<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דשבורד פעילויות ילדים</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f3f3f3; margin: 0; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .layout-top { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-bottom: 20px; }
    .filter-bar, .add-child { background: white; padding: 10px 14px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
    .child-box { background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0px 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
    .child-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 6px; }
    .activity-count { font-size: 0.85rem; color: #555; margin-bottom: 6px; }
    .activity-list { font-size: 0.85rem; text-align: right; max-height: 80px; overflow-y: auto; margin-top: 6px; }
    .activity-item { border-bottom: 1px solid #eee; padding: 2px 0; display: flex; justify-content: space-between; align-items: center; }
    .activity-item:last-child { border-bottom: none; }
    .activity-title { font-weight: bold; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal { background: white; border-radius: 12px; max-width: 550px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .close-btn { border: none; background: transparent; font-size: 1.3rem; cursor: pointer; }
    .modal-section-title { font-weight: bold; margin-top: 10px; margin-bottom: 4px; }
    .add-activity-form label { display: flex; flex-direction: column; gap: 4px; font-size: 0.9rem; margin-bottom: 6px; }
    .add-activity-form input, .add-activity-form textarea { font-size: 0.9rem; padding: 4px 6px; }
    .add-activity-form button { padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; }
    .add-activity-form button:hover { background: #e0e0e0; }
    @media(max-width:600px){.add-activity-form{grid-template-columns:1fr;}}
    button.delete-btn{background:#ff5555;color:white;border:none;border-radius:6px;padding:2px 6px;cursor:pointer;margin-left:6px;}
    button.delete-btn:hover{background:#ff0000;}
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
<h1>דשבורד פעילויות ילדים</h1>

<div class="layout-top">
  <div class="filter-bar">
    <label>תאריך להצגה: <input type="date" id="dateFilter"></label>
    <button id="todayBtn">היום</button>
  </div>
  <div class="add-child">
    <input type="text" id="childNameInput" placeholder="שם ילד">
    <button id="addChildBtn">הוסף ילד</button>
  </div>
</div>

<div class="dashboard" id="dashboard"></div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"></div>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9IzSor82cM39XgdLbywBdq-bM8m2c_ak",
  authDomain: "mykids-3f832.firebaseapp.com",
  projectId: "mykids-3f832",
  storageBucket: "mykids-3f832.firebasestorage.app",
  messagingSenderId: "869870400492",
  appId: "1:869870400492:web:80200b8102afb53e1c06c9",
  measurementId: "G-Q3X18J3SJ4",
  databaseURL:  "https://mykids-3f832-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let childrenData = [];
let currentChildId = null;

function getTodayDateStr() {
  const d = new Date();
  const tzOffset = d.getTimezoneOffset() * 60000;
  return new Date(d - tzOffset).toISOString().slice(0,10);
}

// ======= Render Dashboard =======
function renderDashboard(){
  const dashboard = document.getElementById("dashboard");
  const selectedDate = document.getElementById("dateFilter").value || getTodayDateStr();
  dashboard.innerHTML = "";

  if(!childrenData.length){
    dashboard.innerHTML = "<p>אין ילדים להציג.</p>";
    return;
  }

  childrenData.forEach(child=>{
    const todayActivities = (child.activities||[]).filter(a=>{
      if(a.repeatWeekly){
        return new Date(a.date).getDay() === new Date(selectedDate).getDay();
      }
      return a.date===selectedDate;
    });

    const box = document.createElement("div");
    box.className="child-box";
    box.dataset.id=child.id;

    const nameEl = document.createElement("div");
    nameEl.className="child-name";
    nameEl.textContent=child.name;
    box.appendChild(nameEl);

    const countEl=document.createElement("div");
    countEl.className="activity-count";
    countEl.textContent = todayActivities.length ? `${todayActivities.length} פעילויות ב-${selectedDate}` : `אין פעילויות ב-${selectedDate}`;
    box.appendChild(countEl);

    const listEl=document.createElement("div");
    listEl.className="activity-list";
    todayActivities.forEach(a=>{
      const item=document.createElement("div");
      item.className="activity-item";

      const title=document.createElement("span");
      title.textContent=a.title;
      item.appendChild(title);

      const delBtn=document.createElement("button");
      delBtn.className="delete-btn";
      delBtn.textContent="✕";
      delBtn.onclick=(e)=>{
        e.stopPropagation();
        deleteActivity(child.id,a.id);
      };
      item.appendChild(delBtn);

      listEl.appendChild(item);
    });
    box.appendChild(listEl);

    box.onclick=()=>openChildModal(child.id);

    dashboard.appendChild(box);
  });
}

// ======= Open Modal =======
function openChildModal(childId){
  currentChildId = childId;
  const child = childrenData.find(c=>c.id===childId);
  if(!child) return;
  const backdrop=document.getElementById("modalBackdrop");
  const titleEl=document.getElementById("modalTitle");
  const contentEl=document.getElementById("modalContent");
  const selectedDate = document.getElementById("dateFilter").value || getTodayDateStr();

  titleEl.textContent=`פעילויות של ${child.name}`;
  contentEl.innerHTML="";

  const listTitle=document.createElement("div");
  listTitle.className="modal-section-title";
  listTitle.textContent="כל הפעילויות:";
  contentEl.appendChild(listTitle);

  const listContainer=document.createElement("div");
  listContainer.className="activity-list";

  (child.activities||[]).forEach(a=>{
    const item=document.createElement("div");
    item.className="activity-item";

    const text=document.createElement("span");
    text.textContent=`${a.date} ${a.title} ${a.repeatWeekly?"(חוזרת שבועית)":""}`;
    item.appendChild(text);

    const delBtn=document.createElement("button");
    delBtn.className="delete-btn";
    delBtn.textContent="✕";
    delBtn.onclick=(e)=>{
      e.stopPropagation();
      deleteActivity(child.id,a.id);
    };
    item.appendChild(delBtn);

    listContainer.appendChild(item);
  });
  contentEl.appendChild(listContainer);

  // ====== Add Activity Form ======
  const formTitle=document.createElement("div");
  formTitle.className="modal-section-title";
  formTitle.textContent="הוספת פעילות חדשה:";
  contentEl.appendChild(formTitle);

  const form=document.createElement("form");
  form.className="add-activity-form";

  const dateLabel=document.createElement("label");
  dateLabel.textContent="תאריך:";
  const dateInput=document.createElement("input");
  dateInput.type="date"; dateInput.required=true;
  dateInput.value=selectedDate;
  dateLabel.appendChild(dateInput);

  const titleLabel=document.createElement("label");
  titleLabel.textContent="כותרת:";
  const titleInput=document.createElement("input");
  titleInput.type="text"; titleInput.required=true;
  titleLabel.appendChild(titleInput);

  const repeatLabel=document.createElement("label");
  repeatLabel.textContent="פעילות חוזרת שבועית:";
  const repeatInput=document.createElement("input");
  repeatInput.type="checkbox";
  repeatLabel.appendChild(repeatInput);

  const addBtn=document.createElement("button");
  addBtn.type="submit"; addBtn.textContent="שמור פעילות";

  form.appendChild(dateLabel);
  form.appendChild(titleLabel);
  form.appendChild(repeatLabel);
  form.appendChild(addBtn);

  form.onsubmit=(e)=>{
    e.preventDefault();
    addActivity(child.id,{
      id:"a_"+Date.now(),
      date:dateInput.value,
      title:titleInput.value.trim(),
      repeatWeekly:repeatInput.checked
    });
    openChildModal(child.id);
  };

  contentEl.appendChild(form);
  backdrop.style.display="flex";
}

// ======= Close Modal =======
document.getElementById("closeModal").onclick=()=>document.getElementById("modalBackdrop").style.display="none";
document.getElementById("modalBackdrop").onclick=(e)=>{if(e.target===document.getElementById("modalBackdrop")) document.getElementById("modalBackdrop").style.display="none";}

// ======= CRUD =======
function addChild(name){
  const newChild={id:"c_"+Date.now(),name,activities:[]};
  db.ref("children/"+newChild.id).set(newChild);
}
function addActivity(childId,activity){
  db.ref("children/"+childId+"/activities/"+activity.id).set(activity);
}
function deleteActivity(childId,activityId){
  db.ref("children/"+childId+"/activities/"+activityId).remove();
}
function deleteChild(childId){
  db.ref("children/"+childId).remove();
}

// ======= Events =======
document.getElementById("addChildBtn").onclick=()=>{
  const name=document.getElementById("childNameInput").value.trim();
  if(!name) return alert("נא להזין שם ילד");
  addChild(name);
  document.getElementById("childNameInput").value="";
};

document.getElementById("dateFilter").value=getTodayDateStr();
document.getElementById("dateFilter").onchange=renderDashboard;
document.getElementById("todayBtn").onclick=()=>{document.getElementById("dateFilter").value=getTodayDateStr(); renderDashboard();};

// ======= Load Data from Firebase =======
db.ref("children").on("value",snapshot=>{
  const val=snapshot.val();
  childrenData=val ? Object.values(val) : [];
  renderDashboard();
});
</script>
</body>
</html>
