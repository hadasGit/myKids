<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">×”×œ×•×— ×©×œ×™</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f3f3f3; margin: 0; padding: 20px; direction: rtl; }
        h1 { text-align: center; color: #333; }
        #auth-section { text-align: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        #kids-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); grid-gap: 15px; margin-top: 20px; }
        .kid-box { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0px 2px 5px rgba(0,0,0,0.1); font-size: 18px; cursor: pointer; position: relative; }
        .delete-kid { position: absolute; top: 5px; right: 5px; cursor: pointer; color: red; font-weight: bold; font-size: 20px; }
        #addKidBtn { display: block; width: 100%; padding: 15px; margin-top: 20px; font-size: 18px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer; }
        
        #family-timeline { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 5px solid #4CAF50; }
        .timeline-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .timeline-time { font-weight: bold; width: 60px; color: #4CAF50; }
        .timeline-content { flex-grow: 1; }
        .timeline-kid-name { font-size: 0.8rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .settings-btn { position: absolute; left: 15px; top: 15px; background: none; border: none; font-size: 20px; cursor: pointer; }

        #dateFilter { padding: 6px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
        #modalBackdrop, #settingsModalBackdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; z-index: 999; }
        #modal, .settings-modal { background: white; border-radius: 12px; max-width: 400px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 20px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { border: none; background: transparent; font-size: 1.5rem; cursor: pointer; }
        .activity-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .add-activity-form { display: flex; flex-direction: column; gap: 8px; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top:15px; }
        .add-activity-form input, .settings-modal input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .permanent-note { background: #ffe5c2; color: #c45d00; padding: 6px 10px; border-radius: 10px; font-size: 13px; margin-top: 6px; font-weight: bold; }
        .btn-google { background: #4285F4; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-edit { background: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        .btn-delete { background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        .btn-toggle { padding: 5px 12px; cursor: pointer; border: 1px solid #4CAF50; background: white; color: #4CAF50; transition: 0.3s; }
        .btn-toggle.active { background: #4CAF50; color: white; }
    </style>
</head>
<body>

<div id="auth-section">
    <button id="settingsBtn" class="settings-btn" style="display:none;">âš™ï¸</button>
    <div id="user-info">
        <p id="user-status">×˜×•×¢×Ÿ...</p>
        <button id="loginBtn" class="btn-google" style="display:none;">×”×ª×—×‘×¨×•×ª ×¢× Google</button>
        <button id="logoutBtn" style="display:none; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">×”×ª× ×ª×§</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <h1 id="app-title">×”×œ×•×— ×©×œ×™</h1>
    
    <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom: 20px;">
        <input type="date" id="dateFilter">
        <button id="refreshBtn" style="background:#4CAF50; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">ğŸ”„ ×¡× ×Ÿ</button>
    </div>

    <div id="family-timeline" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin:0;">ğŸ“… ×œ×•"×– ××©×¤×—×ª×™</h3>
            <div class="view-selector">
                <button id="viewDaily" class="btn-toggle">×™×•××™</button>
                <button id="viewWeekly" class="btn-toggle">×©×‘×•×¢×™</button>
            </div>
           <select id="typeFilter" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="all">×”×›×œ (×ª×¦×•×’×” ××œ××”)</option>
                <option value="transport">×¨×§ ×”×¡×¢×•×ª ğŸš—</option>
                <option value="permanent">×¨×§ ×¤×ª×§×™× ×§×‘×•×¢×™× ğŸ“Œ</option>
                <option value="recurring">×¨×§ ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª ğŸ”</option>
                <option value="regular">×¤×¢×™×œ×•×™×•×ª ×—×“-×¤×¢××™×•×ª</option>
            </select>
            <button id="whatsappShareBtn" style="background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">×©×ª×£ ×‘-WhatsApp ğŸŸ¢</button>
        </div>
        <div id="timeline-list"></div>
    </div>
    
    <button id="addKidBtn">×”×•×¡×£ ×—×“×©</button>
    <div id="kids-container"></div>
</div>

<div id="settingsModalBackdrop">
    <div class="settings-modal">
        <div class="modal-header">
            <h3>âš™ï¸ ×”×’×“×¨×•×ª</h3>
            <button class="close-btn" id="closeSettings">&times;</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <label>×©× ×”××¤×œ×™×§×¦×™×”: <input type="text" id="setAppTitle" style="width:100%"></label>
            <label>×©× ×”×™×©×•×ª (×™×œ×“/×—×•×’): <input type="text" id="setEntityName" style="width:100%"></label>
            <label><input type="checkbox" id="setWeeklyDefault"> ×ª×¦×•×’×” ×©×‘×•×¢×™×ª ×›×‘×¨×™×¨×ª ××—×“×œ</label>
            <button id="saveSettingsBtn" style="padding:10px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer;">×©××•×¨ ×”×’×“×¨×•×ª</button>
        </div>
    </div>
</div>

<div id="modalBackdrop">
    <div id="modal">
        <div class="modal-header">
            <h3 id="modalTitle" style="margin:0;"></h3>
            <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9IzSor82cM39XgdLbywBdq-bM8m2c_ak",
  authDomain: "mykids-3f832.firebaseapp.com",
  projectId: "mykids-3f832",
  storageBucket: "mykids-3f832.firebasestorage.app",
  messagingSenderId: "869870400492",
  appId: "1:869870400492:web:80200b8102afb53e1c06c9",
  measurementId: "G-Q3X18J3SJ4",
  databaseURL:  "https://mykids-3f832-default-rtdb.firebaseio.com"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let userKidsRef = null;
let userSettingsRef = null;
let currentTimelineView = 'daily';
let currentFilterType = 'all';
let appSettings = { title: "×”×œ×•×— ×©×œ×™", entityName: "×¤×¢×™×œ×•×ª", defaultView: "daily" };

const todayStr = () => new Date().toISOString().slice(0, 10);
document.getElementById("dateFilter").value = todayStr();

function getNextOccurrence(originalDateStr, targetDateStr) {
    let original = new Date(originalDateStr);
    let target = new Date(targetDateStr);
    if (original >= target) return originalDateStr;
    let next = new Date(original);
    while (next < target) { next.setDate(next.getDate() + 7); }
    return next.toISOString().slice(0, 10);
}

function updateUI() {
    document.getElementById("app-title").textContent = appSettings.title;
    document.getElementById("page-title").textContent = appSettings.title;
    document.getElementById("addKidBtn").textContent = `×”×•×¡×¤×ª ${appSettings.entityName}`;
    updateToggleButtons();
}

function updateToggleButtons() {
    document.getElementById("viewDaily").classList.toggle('active', currentTimelineView === 'daily');
    document.getElementById("viewWeekly").classList.toggle('active', currentTimelineView === 'weekly');
}

function refreshData() {
    if (userKidsRef) userKidsRef.once("value", s => renderKids(s.val()));
}

// --- ××™×¨×•×¢×™ ×›×¤×ª×•×¨×™× ---
document.getElementById("viewDaily").onclick = () => { currentTimelineView = 'daily'; refreshData(); };
document.getElementById("viewWeekly").onclick = () => { currentTimelineView = 'weekly'; refreshData(); };
document.getElementById("typeFilter").onchange = (e) => { currentFilterType = e.target.value; refreshData(); };
document.getElementById("refreshBtn").onclick = () => refreshData();
document.getElementById("closeModal").onclick = () => document.getElementById("modalBackdrop").style.display = "none";
document.getElementById("closeSettings").onclick = () => document.getElementById("settingsModalBackdrop").style.display = "none";

document.getElementById("settingsBtn").onclick = () => {
    document.getElementById("setAppTitle").value = appSettings.title;
    document.getElementById("setEntityName").value = appSettings.entityName;
    document.getElementById("setWeeklyDefault").checked = appSettings.defaultView === 'weekly';
    document.getElementById("settingsModalBackdrop").style.display = "flex";
};

document.getElementById("saveSettingsBtn").onclick = () => {
    const title = document.getElementById("setAppTitle").value;
    const entity = document.getElementById("setEntityName").value;
    const isWeekly = document.getElementById("setWeeklyDefault").checked;
    if (title && entity) {
        userSettingsRef.update({ title, entityName: entity, defaultView: isWeekly ? 'weekly' : 'daily' });
        document.getElementById("settingsModalBackdrop").style.display = "none";
    }
};

document.getElementById("loginBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
document.getElementById("logoutBtn").onclick = () => auth.signOut();

document.getElementById("addKidBtn").onclick = () => {
    const name = prompt(`×©× ×”${appSettings.entityName}:`);
    if (name && userKidsRef) {
        const ref = userKidsRef.push();
        ref.set({ id: ref.key, name, activities: [] });
    }
};

// --- × ×™×”×•×œ ××©×ª××© ---
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById("user-status").textContent = `×©×œ×•×, ${user.displayName}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("settingsBtn").style.display = "block";
        document.getElementById("main-content").style.display = "block";
        
        userSettingsRef = db.ref(`users/${user.uid}/settings`);
        userSettingsRef.on("value", snap => {
            if (snap.exists()) {
                appSettings = snap.val();
                if (!window.initialLoadDone) {
                    currentTimelineView = appSettings.defaultView || 'daily';
                    window.initialLoadDone = true;
                }
                updateUI();
            }
        });

        userKidsRef = db.ref(`users/${user.uid}/kids`);
        userKidsRef.on("value", snapshot => renderKids(snapshot.val()));
    } else {
        document.getElementById("user-status").textContent = "×× × ×”×ª×—×‘×¨×™ ×œ×¦×¤×™×™×” ×‘× ×ª×•× ×™×";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("main-content").style.display = "none";
        userKidsRef = null;
    }
});

function renderKids(kids) {
    const container = document.getElementById("kids-container");
    const timelineList = document.getElementById("timeline-list");
    const timelineContainer = document.getElementById("family-timeline");
    container.innerHTML = "";
    timelineList.innerHTML = "";
    if (!kids) { timelineContainer.style.display = "none"; return; }

    const selectedDate = document.getElementById("dateFilter").value;
    const baseDate = new Date(selectedDate);
    let allActivities = [];

    Object.keys(kids).forEach(kidId => {
        const kid = kids[kidId];
        const activities = kid.activities || [];
        
        // 1. ××™×¡×•×£ ×œ×œ×•"×– ×”××©×•×ª×£ ×¢× ×¡×™× ×•×Ÿ ××ª×§×“×
        activities.forEach(a => {
            // ×œ×•×’×™×§×ª ×¡× × ×™×
            if (currentFilterType === 'transport' && !a.isTransport) return;
            if (currentFilterType === 'permanent' && !a.isPermanent) return;
            if (currentFilterType === 'recurring' && !a.repeatWeekly) return;
            if (currentFilterType === 'regular' && (a.isTransport || a.isPermanent || a.repeatWeekly)) return;

            const checkMatch = (dStr) => {
                const d = new Date(dStr);
                return a.date === dStr || 
                       (a.repeatWeekly && new Date(a.date).getDay() === d.getDay()) || 
                       (a.isPermanent && a.date <= dStr);
            };

            if (currentTimelineView === 'daily') {
                if (checkMatch(selectedDate)) allActivities.push({ ...a, kidName: kid.name, displayDate: selectedDate });
            } else {
                for (let i = 0; i < 7; i++) {
                    let t = new Date(baseDate); t.setDate(baseDate.getDate() + i);
                    let ts = t.toISOString().slice(0, 10);
                    if (checkMatch(ts)) allActivities.push({ ...a, kidName: kid.name, displayDate: ts });
                }
            }
        });

        // 2. ×‘× ×™×™×ª ×§×•×‘×™×™×ª ×”×™×œ×“ - ×”×—×–×¨×ª ×›×œ ×”××™×™×§×•× ×™× ×•×”×§×‘×•×¢×™×
        const box = document.createElement("div");
        box.className = "kid-box";
        box.onclick = () => openKidModal(kidId, kid);
        
        // ×›×•×ª×¨×ª ×©×
        const nameEl = document.createElement("div");
        nameEl.innerHTML = `<strong>${kid.name}</strong>`;
        nameEl.style.fontSize = "22px";
        nameEl.style.marginBottom = "10px";
        box.appendChild(nameEl);

        const actList = document.createElement("div");
        activities.forEach(a => {
            const isMatch = !a.isPermanent && (a.date === selectedDate || (a.repeatWeekly && new Date(a.date).getDay() === baseDate.getDay()));
            if (isMatch) {
                const aEl = document.createElement("div");
                aEl.style.fontSize = "15px";
                // ×”×—×–×¨×ª ×”××™×™×§×•× ×™× ×œ×§×•×‘×™×•×ª
                aEl.textContent = `${a.time || ""} ${a.title}${a.isTransport ? ' ğŸš—' : ''}${a.repeatWeekly ? ' ğŸ”' : ''}`;
                actList.appendChild(aEl);
            }
        });
        box.appendChild(actList);

        // ×”×—×–×¨×ª ×”×¤×ª×§×™× ×”×§×‘×•×¢×™× ×œ×§×•×‘×™×™×ª ×”×™×œ×“
        activities.filter(a => a.isPermanent && a.date <= selectedDate).forEach(note => {
            const nDiv = document.createElement("div");
            nDiv.className = "permanent-note";
            nDiv.textContent = `ğŸ“Œ ${note.title}`;
            box.appendChild(nDiv);
        });

        // ×›×¤×ª×•×¨ ××—×™×§×ª ×™×œ×“
        const del = document.createElement("span");
        del.className = "delete-kid"; del.innerHTML = "&times;";
        del.onclick = (e) => { e.stopPropagation(); if(confirm(`×œ××—×•×§ ××ª ${kid.name}?`)) userKidsRef.child(kidId).remove(); };
        box.appendChild(del);

        container.appendChild(box);
    });

    // 3. ×¨×™× ×“×•×¨ ×”×œ×•"×– ×”××¨×•×›×–
    renderTimelineList(allActivities, timelineList, timelineContainer);
}

// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×¨×™× ×“×•×¨ ×”×¨×©×™××” (×›×“×™ ×©×”×§×•×“ ×™×”×™×” × ×§×™)
function renderTimelineList(allActivities, timelineList, timelineContainer) {
    if (allActivities.length > 0) {
        timelineContainer.style.display = "block";
        allActivities.sort((a, b) => a.displayDate.localeCompare(b.displayDate) || (a.time || "99:99").localeCompare(b.time || "99:99"));

        let lastHeader = "";
        allActivities.forEach(act => {
            if (currentTimelineView === 'weekly' && act.displayDate !== lastHeader) {
                const header = document.createElement("div");
                header.style = "background:#eee; padding:4px 8px; font-size:12px; font-weight:bold; margin-top:10px; border-radius:4px; border-right: 3px solid #4CAF50;";
                header.textContent = act.displayDate.split('-').reverse().join('/');
                timelineList.appendChild(header);
                lastHeader = act.displayDate;
            }
            const item = document.createElement("div");
            item.className = "timeline-item";
            item.innerHTML = `
                <span class="timeline-time">${act.time || "--:--"}</span>
                <span class="timeline-content">
                    <span class="timeline-kid-name">${act.kidName}</span> 
                    ${act.isPermanent ? 'ğŸ“Œ ' : ''}${act.title} ${act.isTransport ? 'ğŸš—' : ''} ${act.repeatWeekly ? 'ğŸ”' : ''}
                </span>`;
            timelineList.appendChild(item);
        });
    } else {
        timelineContainer.style.display = "none";
    }
}
    
function openKidModal(kidId, kid, activityToEdit = null) {
    const modalContent = document.getElementById("modalContent");
    const modalTitle = document.getElementById("modalTitle");
    modalTitle.innerHTML = activityToEdit ? `×¢×¨×™×›×”: ${activityToEdit.title}` : kid.name;
    modalContent.innerHTML = "";
    document.getElementById("modalBackdrop").style.display = "flex";
    const activities = kid.activities || [];

    if (!activityToEdit) {
        const shareBtn = document.createElement("button");
        shareBtn.innerHTML = "ğŸ”— ×©×ª×£ ×œ×•×— ×©×œ " + kid.name;
        shareBtn.style = "margin-bottom:15px; background:#10b981; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; width:100%; font-weight:bold;";
        shareBtn.onclick = () => shareEntireKid(kidId, kid.name);
        modalContent.appendChild(shareBtn);

        const list = document.createElement("div");
        activities.sort((a,b) => a.date.localeCompare(b.date)).forEach(a => {
            const item = document.createElement("div");
            item.className = "activity-item";
            let displayDate = a.date;
            if (a.repeatWeekly) displayDate = getNextOccurrence(a.date, todayStr());
            const dateFmt = displayDate.split('-').reverse().join('/');
            item.innerHTML = `<span>${dateFmt} | ${a.time || '--:--'} ${a.title}</span>
                <div>
                    <button class="btn-edit" onclick="event.stopPropagation(); openKidModal('${kidId}', ${JSON.stringify(kid).replace(/"/g, '&quot;')}, ${JSON.stringify(a).replace(/"/g, '&quot;')})">âœï¸</button>
                    <button class="btn-delete" onclick="event.stopPropagation(); deleteActivity('${kidId}', '${a.id}')">ğŸ—‘ï¸</button>
                </div>`;
            list.appendChild(item);
        });
        modalContent.appendChild(list);
    }

    const form = document.createElement("div");
    form.className = "add-activity-form";
    const defDate = activityToEdit ? activityToEdit.date : todayStr();
    form.innerHTML = `
        <input type="date" id="newActDate" value="${defDate}">
        <input type="text" id="newActTitle" placeholder="××” ×¢×•×©×™×?" value="${activityToEdit ? activityToEdit.title : ''}">
        <input type="time" id="newActTime" value="${activityToEdit ? activityToEdit.time : ''}">
        <label><input type="checkbox" id="newActPerm" ${activityToEdit?.isPermanent ? 'checked' : ''}> ×”×•×“×¢×” ×§×‘×•×¢×” ğŸ“Œ</label>
        <label><input type="checkbox" id="newActRepeat" ${activityToEdit?.repeatWeekly ? 'checked' : ''}> ×—×•×–×¨ ×©×‘×•×¢×™ ğŸ”</label>
        <label><input type="checkbox" id="newActTrans" ${activityToEdit?.isTransport ? 'checked' : ''}> ×”×¡×¢×” ğŸš—</label>
        <button id="saveActBtn" style="padding:10px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">×©××•×¨</button>
    `;
    modalContent.appendChild(form);

    document.getElementById("saveActBtn").onclick = () => {
        const title = document.getElementById("newActTitle").value;
        const date = document.getElementById("newActDate").value;
        if (!title || !date) return alert("×—×•×‘×” ×œ××œ× ×”×›×œ");
        const newAct = {
            id: activityToEdit ? activityToEdit.id : "a_" + Date.now(),
            title, date,
            time: document.getElementById("newActTime").value || "",
            isPermanent: document.getElementById("newActPerm").checked,
            repeatWeekly: document.getElementById("newActRepeat").checked,
            isTransport: document.getElementById("newActTrans").checked
        };
        const newList = activityToEdit ? activities.map(a => a.id === activityToEdit.id ? newAct : a) : [...activities, newAct];
        userKidsRef.child(kidId).child("activities").set(newList).then(() => {
            userKidsRef.child(kidId).once("value", s => openKidModal(kidId, s.val()));
        });
    };
}

window.deleteActivity = (kidId, actId) => {
    if(!confirm("×œ××—×•×§?")) return;
    userKidsRef.child(kidId).child("activities").once("value", snap => {
        const filtered = (snap.val() || []).filter(a => a.id !== actId);
        userKidsRef.child(kidId).child("activities").set(filtered).then(() => {
            userKidsRef.child(kidId).once("value", s => openKidModal(kidId, s.val()));
        });
    });
};

document.getElementById("whatsappShareBtn").onclick = () => {
    const items = document.querySelectorAll(".timeline-item");
    if (items.length === 0) return alert("××™×Ÿ ×¤×¢×™×œ×•×™×•×ª");
    let msg = `*ğŸ“… ×œ×•"×– ${appSettings.title} ×œ${currentTimelineView === 'daily' ? '×™×•×' : '×©×‘×•×¢'}:*\n\n`;
    Array.from(document.getElementById("timeline-list").children).forEach(el => {
        if (el.style.fontWeight === "bold") msg += `\n*--- ${el.textContent} ---*\n`;
        else msg += `â° ${el.querySelector(".timeline-time").textContent} - ${el.querySelector(".timeline-content").textContent.trim()}\n`;
    });
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg + "\n_× ×©×œ×— ××”××¤×œ×™×§×¦×™×”_")}`, '_blank');
};
</script>
</body>
</html>
